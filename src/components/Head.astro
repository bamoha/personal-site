---
import "../styles/global.css";
import "@fontsource/oldenburg/400.css";
import oldenburg400 from "@fontsource/oldenburg/files/oldenburg-latin-400-normal.woff2";

import { ClientRouter } from "astro:transitions";
import { SITE } from "@consts";

interface Props {
  title: string;
  description: string;
  image?: string;
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site);

const { title, description, image = "/nano.png" } = Astro.props;
---

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" type="image/svg+xml" href="/favicon-light.svg" id="favicon-svg">
<link rel="icon" type="image/x-icon" href="/favicon.ico" sizes="any">
<meta name="generator" content={Astro.generator} />

<link rel="preload" href={oldenburg400} as="font" type="font/woff2" crossorigin/>

<link rel="canonical" href={canonicalURL} />

<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />

<meta property="og:type" content="website" />
<meta property="og:url" content={Astro.url} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={new URL(image, Astro.url)} />

<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={Astro.url} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={new URL(image, Astro.url)} />

<ClientRouter  />

<link rel="alternate" type="application/rss+xml" title={SITE.NAME} href={new URL("rss.xml", Astro.site)} />

<script>
  import type { TransitionBeforeSwapEvent } from "astro:transitions/client";
  document.addEventListener("astro:before-swap", (e) =>
    [
      ...(e as TransitionBeforeSwapEvent).newDocument.head.querySelectorAll(
        "link[as=\"font\"]"
      ),
    ].forEach((link) => link.remove())
  );
</script>

<script is:inline>
  function setTheme(theme) {
    localStorage.setItem("theme", theme);
    updateThemeSwitch(theme);
    toggleTheme(theme === "dark");
  }

  function updateThemeSwitch(theme) {
    const switchElement = document.getElementById("theme-switch");
    const indicator = document.getElementById("theme-switch-indicator");
    const lightButton = document.getElementById("theme-button-light");
    const darkButton = document.getElementById("theme-button-dark");
    
    if (!indicator) return;
    
    if (switchElement && switchElement.classList.contains("opacity-0")) {
      setTimeout(() => {
        switchElement.classList.remove("opacity-0");
        switchElement.classList.add("opacity-100");
      }, 100);
    }
    
    const position = theme === "dark" ? 1 : 0;
    const offset = position * 28;
    indicator.style.transform = `translateX(${offset}px)`;
    
    [lightButton, darkButton].forEach(btn => {
      if (btn) {
        btn.classList.remove("opacity-100");
        btn.classList.add("opacity-60");
      }
    });
    
    const activeButton = theme === "dark" ? darkButton : lightButton;
    if (activeButton) {
      activeButton.classList.remove("opacity-60");
      activeButton.classList.add("opacity-100");
    }
  }

  function toggleCurrentTheme() {
    const currentTheme = localStorage.theme || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
    setTheme(currentTheme === "dark" ? "light" : "dark");
  }

  function init() {
    preloadTheme();
    animate();

    const themeSwitch = document.getElementById("theme-switch");
    themeSwitch?.addEventListener("click", toggleCurrentTheme);
    
    const currentTheme = localStorage.theme || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
    setTimeout(() => {
      updateThemeSwitch(currentTheme);
    }, 100);
  }

  function animate() {
    const animateElements = document.querySelectorAll(".animate");

    animateElements.forEach((element, index) => {
      setTimeout(() => {
        element.classList.add("show");
      }, index * 150);
    });
  }

  function toggleTheme(dark) {
    if (dark) {
      document.documentElement.classList.add("dark");
      updateFavicon(true);
    } else {
      document.documentElement.classList.remove("dark");
      updateFavicon(false);
    }
  }

  function updateFavicon(dark) {
    const faviconSvg = document.getElementById("favicon-svg");
    if (faviconSvg) {
      const newHref = dark ? "/favicon-dark.svg" : "/favicon-light.svg";
      faviconSvg.setAttribute("href", newHref);
    }
  }

  function preloadTheme() {
    const userTheme = localStorage.theme;
    const isDark = userTheme 
      ? userTheme === "dark"
      : window.matchMedia("(prefers-color-scheme: dark)").matches;
    
    if (isDark) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
    
    updateFavicon(isDark);
    
    const fadeInSwitch = () => {
      setTimeout(() => {
        updateThemeSwitch(isDark ? "dark" : "light");
      }, 200);
    };
    
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", fadeInSwitch);
    } else {
      fadeInSwitch();
    }
  }

  preloadTheme();
  document.addEventListener("DOMContentLoaded", () => init());
  document.addEventListener("astro:after-swap", () => init());
</script>

<!-- Cloudflare Web Analytics -->
<script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token": "YOUR_CF_ANALYTICS_TOKEN"}'></script>
