---
import "../styles/global.css";
import "@fontsource/figtree/400.css";
import "@fontsource/figtree/600.css";
import figtree400 from "@fontsource/figtree/files/figtree-latin-400-normal.woff2";
import figtree600 from "@fontsource/figtree/files/figtree-latin-600-normal.woff2";

import { ClientRouter } from "astro:transitions";
import { SITE } from "@consts";

interface Props {
  title: string;
  description: string;
  image?: string;
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site);

const { title, description, image = "/nano.png" } = Astro.props;
---

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" type="image/svg+xml" href="/favicon-light.svg" id="favicon-svg">
<link rel="icon" type="image/x-icon" href="/favicon.ico" sizes="any">
<meta name="generator" content={Astro.generator} />

<link rel="preload" href={figtree400} as="font" type="font/woff2" crossorigin/>
<link rel="preload" href={figtree600} as="font" type="font/woff2" crossorigin/>

<link rel="canonical" href={canonicalURL} />

<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />

<meta property="og:type" content="website" />
<meta property="og:url" content={Astro.url} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={new URL(image, Astro.url)} />

<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={Astro.url} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={new URL(image, Astro.url)} />

<ClientRouter  />

<link rel="alternate" type="application/rss+xml" title={SITE.NAME} href={new URL("rss.xml", Astro.site)} />

<script>
  import type { TransitionBeforeSwapEvent } from "astro:transitions/client";
  document.addEventListener("astro:before-swap", (e) =>
    [
      ...(e as TransitionBeforeSwapEvent).newDocument.head.querySelectorAll(
        "link[as=\"font\"]"
      ),
    ].forEach((link) => link.remove())
  );
</script>

<script is:inline>
  function setTheme(theme) {
    localStorage.setItem("theme", theme);
    updateThemeSwitch(theme);
    
    if (theme === "system") {
      toggleTheme(window.matchMedia("(prefers-color-scheme: dark)").matches);
    } else {
      toggleTheme(theme === "dark");
    }
  }

  function updateThemeSwitch(theme) {
    const switchElement = document.getElementById("theme-switch");
    const indicator = document.getElementById("theme-switch-indicator");
    const lightButton = document.getElementById("theme-button-light");
    const darkButton = document.getElementById("theme-button-dark");
    const systemButton = document.getElementById("theme-button-system");
    
    if (!indicator) return;
    
    if (switchElement && switchElement.classList.contains("opacity-0")) {
      setTimeout(() => {
        switchElement.classList.remove("opacity-0");
        switchElement.classList.add("opacity-100");
      }, 100);
    }
    
    let position = 0;
    if (theme === "dark") {
      position = 1;
    } else if (theme === "system") {
      position = 2;
    }
    
    const offset = position * 28;
    indicator.style.transform = `translateX(${offset}px)`;
    
    [lightButton, darkButton, systemButton].forEach(btn => {
      if (btn) {
        btn.classList.remove("opacity-100");
        btn.classList.add("opacity-60");
      }
    });
    
    const activeButton = theme === "light" ? lightButton : theme === "dark" ? darkButton : systemButton;
    if (activeButton) {
      activeButton.classList.remove("opacity-60");
      activeButton.classList.add("opacity-100");
    }
  }

  function init() {
    preloadTheme();
    animate();

    const lightButton = document.getElementById("theme-button-light");
    const darkButton = document.getElementById("theme-button-dark");
    const systemButton = document.getElementById("theme-button-system");
    
    lightButton?.addEventListener("click", () => setTheme("light"));
    darkButton?.addEventListener("click", () => setTheme("dark"));
    systemButton?.addEventListener("click", () => setTheme("system"));
    
    const currentTheme = localStorage.theme || "system";
    setTimeout(() => {
      updateThemeSwitch(currentTheme);
    }, 100);

    window.matchMedia("(prefers-color-scheme: dark)")
      .addEventListener("change", event => {
        const currentTheme = localStorage.theme || "system";
        if (currentTheme === "system") {
          toggleTheme(event.matches);
        }
      }
    );
  }

  function animate() {
    const animateElements = document.querySelectorAll(".animate");

    animateElements.forEach((element, index) => {
      setTimeout(() => {
        element.classList.add("show");
      }, index * 150);
    });
  }

  function toggleTheme(dark) {
    if (dark) {
      document.documentElement.classList.add("dark");
      updateFavicon(true);
    } else {
      document.documentElement.classList.remove("dark");
      updateFavicon(false);
    }
  }

  function updateFavicon(dark) {
    const faviconSvg = document.getElementById("favicon-svg");
    if (faviconSvg) {
      const newHref = dark ? "/favicon-dark.svg" : "/favicon-light.svg";
      faviconSvg.setAttribute("href", newHref);
    }
  }

  function preloadTheme() {
    const userTheme = localStorage.theme || "system";
    const isDark = userTheme === "dark" 
      ? true 
      : userTheme === "light" 
      ? false 
      : window.matchMedia("(prefers-color-scheme: dark)").matches;
    
    if (isDark) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
    
    updateFavicon(isDark);
    
    const fadeInSwitch = () => {
      setTimeout(() => {
        updateThemeSwitch(userTheme);
      }, 200);
    };
    
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", fadeInSwitch);
    } else {
      fadeInSwitch();
    }
  }

  preloadTheme();
  document.addEventListener("DOMContentLoaded", () => init());
  document.addEventListener("astro:after-swap", () => init());
</script>
